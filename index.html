<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>MPG vs Horsepower — Narrative Visualization</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:"Helvetica Neue",Arial,sans-serif;margin:0;background:#fafafa;color:#111;}
    main{max-width:900px;margin:0 auto;padding:1rem;}
    svg{width:100%;height:500px;}
    nav{display:flex;justify-content:center;gap:1rem;margin-top:1rem;}
    button{padding:0.5rem 1rem;font-size:1rem;border:none;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,0.2);background:#3b82f6;color:#fff;cursor:pointer;transition:background .15s ease;}
    button:hover:not(:disabled){background:#2563eb;}
    button:disabled{background:#9ca3af;cursor:not-allowed;}
    h1{font-size:1.75rem;margin-bottom:0.25rem;}
    #caption{margin:0 0 1rem 0;font-style:italic;color:#374151;}
    .tooltip{position:absolute;pointer-events:none;background:white;padding:0.5rem 0.75rem;border:1px solid #d1d5db;border-radius:6px;font-size:0.85rem;line-height:1.2;box-shadow:0 2px 4px rgba(0,0,0,0.08);opacity:0;transition:opacity .1s ease;white-space:nowrap;}
    .annotation-note-title{font-weight:bold;}
  </style>
  <!-- Required libraries -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/d3-annotation@2.5.1/dist/d3-annotation.min.js"></script>
</head>
<body>
  <main>
    <h1>How Engine Power and Efficiency Evolved (1970‑1982)</h1>
    <p id="caption"></p>
    <div id="vis"></div>
    <nav>
      <button id="prev">◀&nbsp;Back</button>
      <button id="next">Next&nbsp;▶</button>
    </nav>
  </main>
  <div class="tooltip" id="tooltip"></div>
<script>
// ————— Dimensions & SVG —————
const margin = {top:40,right:30,bottom:50,left:60},
      width = 800 - margin.left - margin.right,
      height = 500 - margin.top - margin.bottom;

const svg = d3.select("#vis").append("svg")
    .attr("viewBox",[0,0,width + margin.left + margin.right,height + margin.top + margin.bottom])
  .append("g")
    .attr("transform",`translate(${margin.left},${margin.top})`);

const annotationLayer = svg.append("g").attr("class","annotations");
const tooltip = d3.select("#tooltip");

// ————— Global state —————
const state = { scene:0 };

// Color by origin
const color = d3.scaleOrdinal()
    .domain(["usa","japan","europe"])
    .range(["#1d4ed8","#059669","#d97706"]);

const xSc = d3.scaleLinear().range([0,width]);
const ySc = d3.scaleLinear().range([height,0]);

const xAxisG = svg.append("g").attr("transform",`translate(0,${height})`);
const yAxisG = svg.append("g");

const scenes = [scene0, scene1, scene2];

// ————— Load data —————
d3.csv("https://raw.githubusercontent.com/mwaskom/seaborn-data/master/mpg.csv", d3.autoType).then(raw=>{
  const data = raw.filter(d => d.horsepower != null && d.mpg != null);

  // Aggregate MPG by model year
  const mpgByYear = d3.rollup(data, v => d3.mean(v, d=>d.mpg), d=>d.model_year);
  const yearSeries = Array.from(mpgByYear, ([year, mpg]) => ({year:+year, mpg})).sort((a,b)=>a.year-b.year);

  state.data = data;
  state.yearSeries = yearSeries;

  init();
});

function init(){
  d3.select("#next").on("click",()=>{ if(state.scene < scenes.length-1){ state.scene++; update(); } });
  d3.select("#prev").on("click",()=>{ if(state.scene > 0){ state.scene--; update(); } });
  update();
}

function update(){
  d3.select("#prev").attr("disabled", state.scene===0 ? true:null);
  d3.select("#next").attr("disabled", state.scene===scenes.length-1 ? true:null);

  svg.selectAll(".mark").remove();
  annotationLayer.selectAll("*").remove();

  scenes[state.scene]();
}

// ————— Scene 0 —————
function scene0(){
  const data = state.data;
  xSc.domain(d3.extent(data, d=>d.horsepower)).nice();
  ySc.domain(d3.extent(data, d=>d.mpg)).nice();

  xAxisG.call(d3.axisBottom(xSc));
  yAxisG.call(d3.axisLeft(ySc));

  svg.append("text")
      .attr("x",width/2)
      .attr("y",height+40)
      .attr("text-anchor","middle")
      .text("Horsepower");

  svg.append("text")
      .attr("transform","rotate(-90)")
      .attr("x",-height/2)
      .attr("y",-45)
      .attr("text-anchor","middle")
      .text("Miles per Gallon (MPG)");

  svg.selectAll(".mark")
    .data(data)
    .enter().append("circle")
      .attr("class","mark")
      .attr("cx", d=>xSc(d.horsepower))
      .attr("cy", d=>ySc(d.mpg))
      .attr("r",3)
      .attr("fill", d=>color(d.origin))
      .attr("opacity",0.7);

  addAnnotations([
    {
      note:{title:"Classic trade‑off",label:"Higher horsepower usually means lower MPG."},
      x:xSc(150),y:ySc(14),dx:50,dy:-80
    }
  ]);

  d3.select("#caption").text("Scene 1 – An inverse relationship: powerful engines tend to drink more fuel.");
}

// ————— Scene 1 —————
function scene1(){
  const series = state.yearSeries;
  xSc.domain(d3.extent(series, d=>d.year));
  ySc.domain([d3.min(series,d=>d.mpg)-2, d3.max(series,d=>d.mpg)+2]);

  xAxisG.call(d3.axisBottom(xSc).tickFormat(d=>"19"+d));
  yAxisG.call(d3.axisLeft(ySc));

  const line = d3.line()
     .x(d=>xSc(d.year))
     .y(d=>ySc(d.mpg));

  svg.append("path")
     .datum(series)
     .attr("class","mark")
     .attr("fill","none")
     .attr("stroke","#1d4ed8")
     .attr("stroke-width",2)
     .attr("d",line);

  svg.selectAll(".dot")
     .data(series)
     .enter().append("circle")
       .attr("class","mark dot")
       .attr("cx",d=>xSc(d.year))
       .attr("cy",d=>ySc(d.mpg))
       .attr("r",4)
       .attr("fill","#1d4ed8");

  addAnnotations([
    {
      note:{title:"Efficiency boom",label:"Post‑1973 oil crisis, average MPG jumped ~40% in five years."},
      x:xSc(75),y:ySc(25),dx:-60,dy:-70
    }
  ]);

  d3.select("#caption").text("Scene 2 – After the oil embargo, manufacturers rapidly pushed efficiency upward.");
}

// ————— Scene 2 —————
function scene2(){
  const data = state.data;
  const top = data.slice().sort((a,b)=>d3.descending(a.mpg,b.mpg)).slice(0,10);

  xSc.domain(d3.extent(data, d=>d.horsepower)).nice();
  ySc.domain(d3.extent(data, d=>d.mpg)).nice();

  xAxisG.call(d3.axisBottom(xSc));
  yAxisG.call(d3.axisLeft(ySc));

  // Base points
  svg.selectAll(".mark")
    .data(data)
    .enter().append("circle")
      .attr("class","mark")
      .attr("cx", d=>xSc(d.horsepower))
      .attr("cy", d=>ySc(d.mpg))
      .attr("r",3)
      .attr("fill", d=>color(d.origin))
      .attr("opacity",0.35);

  // Highlight leaders
  svg.selectAll(".highlight")
    .data(top)
    .enter().append("circle")
      .attr("class","mark highlight")
      .attr("cx", d=>xSc(d.horsepower))
      .attr("cy", d=>ySc(d.mpg))
      .attr("r",6)
      .attr("fill","#dc2626")
      .attr("stroke","white")
      .attr("stroke-width",1.5);

  addAnnotations([
    {
      type:d3.annotationCalloutCircle,
      note:{title:"Hyper‑milers",label:"The 10 most efficient cars exceed 40 MPG with modest power."},
      x:xSc(top[0].horsepower),
      y:ySc(top[0].mpg),
      dx:60,dy:-40,
      subject:{radius:40}
    }
  ]);

  // Tooltips
  svg.selectAll("circle")
     .on("mousemove",(event,d)=>{
        tooltip.style("opacity",1)
               .style("left",(event.pageX+10)+"px")
               .style("top",(event.pageY-28)+"px")
               .html(`<strong>${d.name}</strong><br>HP ${d.horsepower}<br>MPG ${d.mpg}`);
     })
     .on("mouseleave",()=> tooltip.style("opacity",0));

  d3.select("#caption").text("Scene 3 – Meet the early ‘hyper‑milers’. Hover to explore any of the 398 cars.");
}

// ————— Helper to drop annotations —————
function addAnnotations(cfg){
  const makeAnn = d3.annotation()
        .annotations(cfg)
        .type(d3.annotationCallout)
        .accessors({x:d=>d.x, y:d=>d.y});
  annotationLayer.call(makeAnn);
}
</script>
</body>
</html>
